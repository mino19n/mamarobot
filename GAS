const SHEET_ID = '1gIMniAC5igFdaOFMhs8AyEjZ7KPUrd41Ca2LBMqZ0o8';  // ã‚ãªãŸã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã«ç½®ãæ›ãˆ
const CHANNEL_ACCESS_TOKEN = "Qg6HS96zcEbuDufwoy/X9kKBKuYNgtvK85Q7FWuF67H+QpAirvRL2aXVDBIAjkDLapjyne+5SuM/g0O8kj0xKpcP8imALNKFMenRBnjFgND2gUPSf0Bkie0UYYfJ9S2fxjMhRLObVZ2oLlcZBvpONwdB04t89/1O/w1cDnyilFU=";

// ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getUserName(userId) {
  const url = `https://api.line.me/v2/bot/profile/${userId}`;

  const headers = {
    "Authorization": `Bearer ${CHANNEL_ACCESS_TOKEN}`
  };

  const options = {
    method: "get",
    headers: headers,
    muteHttpExceptions: true
  };

  const response = UrlFetchApp.fetch(url, options);

  if (response.getResponseCode() === 200) {
    const data = JSON.parse(response.getContentText());
    return data.displayName;  // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¿”ã™
  } else {
    Logger.log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—å¤±æ•—: ${response.getContentText()}`);
    return "ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼";  // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º
  }
}


function doPost(e) {
  // ğŸ“Œ Webhookã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ã‚°ã§ç¢ºèª
  Logger.log(e ? e.postData.contents : 'ãƒ‡ãƒ¼ã‚¿ãªã—');
  try {
      const params = e ? JSON.parse(e.postData.contents) : null;

    if (params && params.events && params.events.length > 0) {
      const event = params.events[0];


      // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—
      const replyToken = event.replyToken;
      const userId = event.source.userId;
      const messageText = event.message.text;

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
      const userName = getUserName(userId);  // ğŸ”¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‹ã‚‰åå‰ã‚’å–å¾—

      // æ—¥ä»˜ã¨æ™‚é–“ã‚’å–å¾—
      const date = new Date();
      const time = date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²
      const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName("ã‚·ãƒ¼ãƒˆ");

      if (messageText === "ã¯ã„" || messageText === "ã„ã„ãˆ") {
        const row = [date.toLocaleDateString('ja-JP'), time, messageText, userName];  // âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§è¨˜éŒ²
        sheet.appendRow(row);

        // LINEã«è¿”ä¿¡
        const replyText = (messageText === "ã¯ã„") ? "ã‚ˆãã§ãã¾ã—ãŸï¼" : "ä»Šã‹ã‚‰ã—ã‚ˆã†ã­ï¼";
        sendReply(replyToken, replyText);
      }
    }
  } catch (error) {
    Logger.log("ã‚¨ãƒ©ãƒ¼: " + error);
  }
}

function sendReply(replyToken, messageText) {
 
  const url = 'https://api.line.me/v2/bot/message/reply';
  const headers = {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${CHANNEL_ACCESS_TOKEN}`
  };

  // ğŸ”¥ LINEã¯é…åˆ—ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
  const messages = [{ type: 'text', text: messageText }];

  const body = JSON.stringify({
    replyToken: replyToken,
    messages: messages
  });

  const options = {
    method: 'post',
    headers: headers,
    payload: body,
    muteHttpExceptions: true
  };

  const response = UrlFetchApp.fetch(url, options);

  if (response.getResponseCode() !== 200) {
    Logger.log(`é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${response.getContentText()}`);
  }
}
