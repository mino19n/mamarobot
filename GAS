const SHEET_ID = '1gIMniAC5igFdaOFMhs8AyEjZ7KPUrd41Ca2LBMqZ0o8';  // ã‚ãªãŸã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã«ç½®ãæ›ãˆ
const CHANNEL_ACCESS_TOKEN = "Qg6HS96zcEbuDufwoy/X9kKBKuYNgtvK85Q7FWuF67H+QpAirvRL2aXVDBIAjkDLapjyne+5SuM/g0O8kj0xKpcP8imALNKFMenRBnjFgND2gUPSf0Bkie0UYYfJ9S2fxjMhRLObVZ2oLlcZBvpONwdB04t89/1O/w1cDnyilFU=";
const GROUP_ID = 'C0973bdef9d19444731d1ca0023f34ff3';  // â† ã‚°ãƒ«ãƒ¼ãƒ—IDã‚’ã“ã“ã«è¨˜è¼‰

// ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getUserName(userId) {
  const url = `https://api.line.me/v2/bot/profile/${userId}`;

  const headers = {
    "Authorization": `Bearer ${CHANNEL_ACCESS_TOKEN}`
  };

  const options = {
    method: "get",
    headers: headers,
    muteHttpExceptions: true
  };

  const response = UrlFetchApp.fetch(url, options);

  if (response.getResponseCode() === 200) {
    const data = JSON.parse(response.getContentText());
    return data.displayName;  // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¿”ã™
  } else {
    Logger.log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—å¤±æ•—: ${response.getContentText()}`);
    return "ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼";  // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º
  }
}

// ğŸ“Œ é€£ç¶šé”æˆæ—¥æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
function updateStreak(userName) {
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName("ã‚·ãƒ¼ãƒˆ");
  const data = sheet.getDataRange().getValues();

  let lastStreak = 0;  // ç›´å‰ã®é€£ç¶šæ—¥æ•°

  // æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é€£ç¶šæ—¥æ•°ã‚’å–å¾—
  for (let i = data.length - 1; i > 0; i--) {
    if (data[i][3] === userName) {  // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒä¸€è‡´
      if (data[i][2] === "ãŠã‚ã£ãŸã‚ˆï¼") {  // ã€ŒãŠã‚ã£ãŸã‚ˆï¼ã€ãªã‚‰é€£ç¶š
        lastStreak = Number(data[i][4]) || 0;  // ç›´å‰ã®é€£ç¶šè¨˜éŒ²ã‚’å–å¾—
        lastStreak++;  // é€£ç¶šè¨˜éŒ²ã‚’+1
      } else {  // ã€Œã„ã„ãˆã€ãªã‚‰ãƒªã‚»ãƒƒãƒˆ
        lastStreak = 0;
      }
      break;
    }
  }
  return lastStreak;
}


function doPost(e) {
  // ğŸ“Œ Webhookã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ã‚°ã§ç¢ºèª
  Logger.log(e ? e.postData.contents : 'ãƒ‡ãƒ¼ã‚¿ãªã—');
  try {
      const params = e ? JSON.parse(e.postData.contents) : null;

    if (params && params.events && params.events.length > 0) {
      const event = params.events[0];


      // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—
      const replyToken = event.replyToken;
      const userId = event.source.userId;
      const messageText = event.message.text;

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
      const userName = getUserName(userId);  // ğŸ”¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‹ã‚‰åå‰ã‚’å–å¾—

      // æ—¥ä»˜ã¨æ™‚é–“ã‚’å–å¾—
      const date = new Date();
      const time = date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²
      const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName("ã‚·ãƒ¼ãƒˆ");

      if (messageText === "ãŠã‚ã£ãŸã‚ˆï¼" || messageText === "ã¾ã ã ã£ãŸâ€¦") {
        const row = [date.toLocaleDateString('ja-JP'), time, messageText, userName];  // âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§è¨˜éŒ²

        // LINEã«è¿”ä¿¡
        const replyText = (messageText === "ãŠã‚ã£ãŸã‚ˆï¼") ? "ã‚ˆãã§ãã¾ã—ãŸï¼" : "ä»Šã‹ã‚‰ã—ã‚ˆã†ã­ï¼";
        sendReply(replyToken, replyText);

        // âœ… ã€ŒãŠã‚ã£ãŸã‚ˆï¼ã€ãªã‚‰ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã—ã¦ã‚°ãƒ«ãƒ¼ãƒ—ã«é€šçŸ¥
        if (messageText === "ãŠã‚ã£ãŸã‚ˆï¼") {
           // âœ… é€£ç¶šé”æˆæ—¥æ•°ã‚’è¨ˆç®—
           const streak = updateStreak(userName);  // é€£ç¶šæ—¥æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
           
           // ğŸ¯ ã‚°ãƒ«ãƒ¼ãƒ—é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«é€£ç¶šæ—¥æ•°ã‚’è¿½åŠ è¡¨ç¤º
           const groupMessage = `${userName}ãŒã‚„ã‚‹ã“ã¨ã‚’å®Œäº†ã—ã¾ã—ãŸï¼ğŸ‰ï¼ˆ${streak}æ—¥é€£ç¶šï¼‰`;
           sendGroupMessage(GROUP_ID, groupMessage);

          // âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²
          row.push(streak);  // Eåˆ—ã«é€£ç¶šæ—¥æ•°ã‚’è¿½åŠ 
          sheet.appendRow(row);
        }
      }
    }
  } catch (error) {
    Logger.log("ã‚¨ãƒ©ãƒ¼: " + error);
  }
}

function sendReply(replyToken, messageText) {
 
  const url = 'https://api.line.me/v2/bot/message/reply';
  const headers = {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${CHANNEL_ACCESS_TOKEN}`
  };

  // ğŸ”¥ LINEã¯é…åˆ—ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
  const messages = [{ type: 'text', text: messageText }];

  const body = JSON.stringify({
    replyToken: replyToken,
    messages: messages
  });

  const options = {
    method: 'post',
    headers: headers,
    payload: body,
    muteHttpExceptions: true
  };

  const response = UrlFetchApp.fetch(url, options);

  if (response.getResponseCode() !== 200) {
    Logger.log(`é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${response.getContentText()}`);
  }
}

// ğŸ“Œ ã‚°ãƒ«ãƒ¼ãƒ—ã«é€šçŸ¥ã‚’é€ä¿¡
function sendGroupMessage(groupId, message) {
  const url = 'https://api.line.me/v2/bot/message/push';

  const headers = {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${CHANNEL_ACCESS_TOKEN}`
  };

  const body = JSON.stringify({
    to: groupId,
    messages: [{ type: 'text', text: message }]
  });

  const options = {
    method: 'post',
    headers: headers,
    payload: body,
    muteHttpExceptions: true
  };

  const response = UrlFetchApp.fetch(url, options);
  if (response.getResponseCode() !== 200) {
    Logger.log(`ã‚°ãƒ«ãƒ¼ãƒ—é€šçŸ¥ã‚¨ãƒ©ãƒ¼: ${response.getContentText()}`);
  }
}
